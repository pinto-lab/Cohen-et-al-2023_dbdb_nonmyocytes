knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(Seurat)
library(reticulate)
library(biomaRt)
library(ggplot2)
source("utilities.R")


# find markers for every cluster compared to all remaining cells, report only the positive ones
dbdb.markers <- FindAllMarkers(dbdb, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
dbdb.markers %>% group_by(cluster) %>% top_n(n = 2, wt = avg_logFC)
save(dbdb, dbdb.markers, file="DBDB2019")
write.csv(dbdb.markers,file="C:/dbdb single cell DATA_cr5.0/dbdb.markers.csv",row.names = FALSE,quote = FALSE)

```
#DIMPLOT
```{r markers}
DimPlot(dbdb, reduction = "tSNE",label=TRUE, label.size=5) + NoLegend()

FeaturePlot(dbdb, "Ddah1", col=c('lightgray', 'red'), split.by='trt', sort.cell=TRUE,reduction="tSNE")

VlnPlot(dbdb, features=c("Snca"),split.by = "trt") 

FeaturePlot(dbdb, "Cd74", col=c('lightgray', 'red'), split.by='trt', sort.cell=TRUE,reduction="tSNE")

FeaturePlot(dbdb, "Csf1r", col=c('lightgray', 'red'), split.by='trt', sort.cell=TRUE,reduction="tSNE")

top10 <-dbdb.markers %>% group_by(cluster) %>% top_n(10, avg_logFC)

Cl0_markers<-DotPlot(dbdb,features = unique(top10$gene[top10$cluster=="0"]),cols = c("blue", "red"))+theme_bw()+
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust=1,vjust=0.5))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+theme(axis.text=element_text(size=10),
                                                                                      axis.title=element_text(size=10))+xlab("Gene")+ylab("Cluster")

```

```{r}
# Top marker genes p_val for ordered dotplot #
load("C:/dbdb single cell DATA_cr5.0/dbdb_Seurat_Final_Object.RData")

new.cluster.ids <- c("Fibroblasts", "Fibroblasts", "Endocardial", "ECs", "Macrophages", "Fibroblasts", "B-cells", "Fibroblasts", "LECs", "Fibroblasts", "Pericytes", "Endocardial", "Macrophages", "Macrophages", "ECs", "T-cells", "ECs", "Fibroblasts", "DC-like", "NK cells", "SMCs", "T-cells", "Granulocytes", "Fibroblasts", "Fibroblasts", "Schwann cells", "Epicardial")
names(new.cluster.ids) <- levels(dbdb)
dbdb <- RenameIdents(dbdb, new.cluster.ids)

dbdb.markers <- read.csv("C:/dbdb single cell DATA_cr5.0/dbdb.markers.csv")

topNmarker <- function(object, markers, n){
  top100 <- markers %>% group_by(cluster) %>% top_n(100, p_val)
  topN<-NULL
  pops <- as.character(object@active.ident)
  for(i in 1:length(unique(pops))){
    topN.temp<-markers[markers$cluster==unique(top100$cluster)[i],][1:n,]
    topN<-rbind(topN, topN.temp)
  }
  topN<-topN[!is.na(topN$gene),]
  return(topN)
}
top5 <- topNmarker(dbdb, dbdb.markers, 5)

DotPlot(dbdb, features = unique(top5$gene),cols = c("#403891ff", "#f68f46ff"))+theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust=1,vjust=0.5))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.text=element_text(size=10),axis.title=element_text(size=10))+
  xlab("Gene")+ylab("Cluster")+ theme(legend.position="top")
